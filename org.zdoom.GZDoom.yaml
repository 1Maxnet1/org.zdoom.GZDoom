app-id: org.zdoom.GZDoom
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: "20.08"
command: gzdoom.sh

finish-args:
- --device=dri
- --socket=wayland
- --socket=fallback-x11
- --socket=x11
- --share=ipc
- --share=network
- --socket=pulseaudio

# Based on GZDoom
# We redirect the original ~/.config/gzdoom
- --env=DOOMWADDIR=/app/share/games/doom
- --persist=.config/gzdoom

# Simpler way of preventing KDE related errors
- --env=KDE_FULL_SESSION=false

cleanup:
- /app/include
- /app/lib/*.a
- /app/lib/*.la
- /app/lib/pkgconfig

modules:

- name: mpg123
  buildsystem: autotools
  sources:
  - type: archive
    url: https://sourceforge.net/projects/mpg123/files/mpg123/1.27.2/mpg123-1.27.2.tar.bz2
    sha256: 52f6ceb962c05db0c043bb27acf5a721381f5f356ac4610e5221f50293891b04

- name: libsdnfile
  buildsystem: cmake
  config-opts:
  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  - -DBUILD_SHARED_LIBS=ON
  sources:
  - type: archive
    url: https://github.com/libsndfile/libsndfile/archive/refs/tags/1.0.31.tar.gz
    sha256: 8cdee0acb06bb0a3c1a6ca524575643df8b1f3a55a0893b4dd9f829d08263785

- name: openal
  buildsystem: cmake
  config-opts:
  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  sources:
  - type: archive
    url: https://github.com/kcat/openal-soft/archive/refs/tags/1.21.1.tar.gz
    sha256: 8ac17e4e3b32c1af3d5508acfffb838640669b4274606b7892aa796ca9d7467f

# Upgrading to 2.2.x can only be done with ZMusic 1.1.8 which is not out yet
# FluidSynth 2.2.x will also include a proper SDL2 backend which should resolve
# the warning messages you now get.
- shared-modules/linux-audio/fluidsynth2.json

- name: game-music-emu
  buildsystem: cmake
  config-opts:
  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  sources:
  - type: archive
    url: https://bitbucket.org/mpyne/game-music-emu/downloads/game-music-emu-0.6.3.tar.gz
    sha256: 626e8a104e0dadd10ef6519a67aca880c7b40f81471659f1935b61754e12fc7b

# Music library behind zdoom
- name: zmusic
  buildsystem: cmake-ninja
  config-opts:
  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  sources:
  - type: archive
    url: https://github.com/coelckers/ZMusic/archive/1.1.7.tar.gz
    sha256: 3800e40da5015fb3eee408b0639d69ece49cfd0d00466292e48b8ff94383d9f2

# This builds both the application code and
# the custom game data
- name: gzdoom
  buildsystem: cmake-ninja
  config-opts:
  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  sources:
  - type: git
    url: https://github.com/coelckers/gzdoom.git
    tag: g4.5.0
    commit: 3037c08840f209f9f6b6d7e6c2c69632472a5d54
  - type: file
    url: https://github.com/coelckers/gzdoom/raw/g4.5.0/soundfont/gzdoom.sf2
    sha256: fca3e514b635a21789d4224e84865d2954a2a914d46b64aa8219ddb565c44869
  # I've discussed these patches upstream and a special -DFLATPAK_BUNDLE has been approved
  # https://forum.zdoom.org/viewtopic.php?f=15&t=68365&sid=884a41102b499f98ed9c76a62ee0e41d
  - type: patch
    path: description.patch
  - type: shell
    commands:
    - install -Dm 644 gzdoom.sf2 /app/share/sounds/sf2/gzdoom.sf2

- name: launcher
  buildsystem: simple
  sources:
  - type: script
    commands:
    - gzdoom +fluid_patchset /app/share/sounds/sf2/gzdoom.sf2 -file lights.pk3 brightmaps.pk3 "$@"
    dest-filename: gzdoom.sh
  - type: file
    path: org.zdoom.GZDoom.desktop
  - type: file
    path: org.zdoom.GZDoom.appdata.xml
  - type: file
    path: org.zdoom.GZDoom.48.png
  - type: file
    path: org.zdoom.GZDoom.64.png
  - type: file
    path: org.zdoom.GZDoom.128.png
  build-commands:
  - install -D gzdoom.sh /app/bin/gzdoom.sh
  - install -Dm 644 org.zdoom.GZDoom.desktop -t /app/share/applications
  - install -Dm 644 org.zdoom.GZDoom.appdata.xml -t /app/share/metainfo
  - install -Dm 644 org.zdoom.GZDoom.48.png /app/share/icons/hicolor/48x48/apps/org.zdoom.GZDoom.png
  - install -Dm 644 org.zdoom.GZDoom.64.png /app/share/icons/hicolor/64x64/apps/org.zdoom.GZDoom.png
  - install -Dm 644 org.zdoom.GZDoom.128.png /app/share/icons/hicolor/128x128/apps/org.zdoom.GZDoom.png
